<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pegger's Tipping 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e17;
    --surface: #111827;
    --surface2: #1a2236;
    --border: #1f2d45;
    --accent: #f0b429;
    --accent2: #38bdf8;
    --red: #ef4444;
    --green: #22c55e;
    --text: #e2e8f0;
    --muted: #64748b;
    --font-display: 'Barlow Condensed', sans-serif;
    --font-body: 'Barlow', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-body); min-height: 100vh; }

  /* HEADER */
  header {
    background: var(--surface);
    border-bottom: 2px solid var(--accent);
    padding: 12px 24px;
    display: flex;
    flex-direction: column;
    position: sticky; top: 0; z-index: 100;
  }
  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
  }
  .logo {
    font-family: var(--font-display);
    font-size: 22px;
    font-weight: 900;
    letter-spacing: 2px;
    color: var(--accent);
    text-transform: uppercase;
    line-height: 1.2;
  }
  .logo span { color: var(--text); }
  .logo small { display: block; font-size: 11px; font-weight: 400; letter-spacing: 0.5px; color: var(--muted); text-transform: none; }
  nav { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 10px; }
  nav button {
    background: none; border: none; color: var(--muted);
    font-family: var(--font-display); font-size: 14px; font-weight: 700;
    letter-spacing: 1px; text-transform: uppercase;
    padding: 6px 12px; cursor: pointer; border-radius: 6px;
    transition: all 0.2s;
  }
  nav button:hover { color: var(--text); background: var(--surface2); }
  nav button.active { color: var(--accent); background: rgba(240,180,41,0.1); }
  .admin-btn {
    background: var(--surface2) !important;
    color: var(--accent2) !important;
    border: 1px solid var(--accent2) !important;
  }
  @media (max-width: 600px) {
    header { padding: 10px 16px; }
    .logo { font-size: 18px; }
    nav button { font-size: 12px; padding: 5px 9px; }
    .view { padding: 20px 12px; }
    .section-title { font-size: 24px; }
    .admin-grid { grid-template-columns: 1fr; }
    .tip-grid { grid-template-columns: repeat(2, 1fr); }
    .dash-grid { grid-template-columns: 1fr; }
  }

  /* VIEWS */
  .view { display: none; padding: 32px 24px; max-width: 1400px; margin: 0 auto; }
  .view.active { display: block; }

  /* LEADERBOARD */
  .round-info {
    display: flex; align-items: center; gap: 16px; margin-bottom: 24px;
  }
  .round-badge {
    background: var(--accent); color: #000;
    font-family: var(--font-display); font-weight: 900;
    font-size: 13px; letter-spacing: 2px; text-transform: uppercase;
    padding: 4px 12px; border-radius: 4px;
  }
  .section-title {
    font-family: var(--font-display); font-size: 32px; font-weight: 900;
    letter-spacing: 2px; text-transform: uppercase; color: var(--text);
  }
  .section-title span { color: var(--accent); }

  table { width: 100%; border-collapse: collapse; }
  th {
    font-family: var(--font-display); font-size: 12px; font-weight: 700;
    letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted);
    padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border);
  }
  td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
  tr:hover td { background: var(--surface2); }

  .rank-cell {
    font-family: var(--font-display); font-size: 22px; font-weight: 900;
    color: var(--muted); width: 48px;
  }
  .rank-1 { color: var(--accent); }
  .rank-2 { color: #94a3b8; }
  .rank-3 { color: #cd7c3a; }

  .tipper-name {
    font-family: var(--font-display); font-size: 18px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .team-badge {
    display: inline-block;
    background: var(--surface2); border: 1px solid var(--border);
    font-family: var(--font-display); font-size: 11px; font-weight: 700;
    padding: 2px 6px; border-radius: 3px; color: var(--muted);
    letter-spacing: 1px;
  }
  .score-cell {
    font-family: var(--font-display); font-size: 20px; font-weight: 900;
  }
  .week-score { font-size: 13px; color: var(--muted); }
  .pos-change { font-size: 13px; font-weight: 600; }
  .pos-up { color: var(--green); }
  .pos-down { color: var(--red); }
  .pos-same { color: var(--muted); }
  .power-bar {
    height: 6px; background: var(--border); border-radius: 3px; width: 80px;
  }
  .power-fill { height: 100%; background: var(--accent2); border-radius: 3px; transition: width 0.5s; }

  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 24px; margin-bottom: 24px;
  }
  .card-title {
    font-family: var(--font-display); font-size: 14px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase; color: var(--muted);
    margin-bottom: 16px;
  }

  /* DASHBOARD */
  .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 24px; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px;
  }
  .stat-label { font-size: 12px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
  .stat-value { font-family: var(--font-display); font-size: 36px; font-weight: 900; color: var(--accent); }
  .stat-sub { font-size: 13px; color: var(--muted); margin-top: 4px; }

  .podium {
    display: flex; align-items: flex-end; gap: 8px; justify-content: center;
    padding: 24px 0;
  }
  .podium-item { display: flex; flex-direction: column; align-items: center; gap: 8px; }
  .podium-name { font-family: var(--font-display); font-weight: 700; font-size: 16px; text-transform: uppercase; }
  .podium-score { font-size: 13px; color: var(--muted); }
  .podium-block {
    width: 90px; border-radius: 8px 8px 0 0;
    display: flex; align-items: center; justify-content: center;
    font-family: var(--font-display); font-size: 32px; font-weight: 900;
  }
  .podium-1 .podium-block { height: 120px; background: var(--accent); color: #000; }
  .podium-2 .podium-block { height: 90px; background: #475569; color: var(--text); }
  .podium-3 .podium-block { height: 70px; background: #92400e; color: var(--text); }

  /* Round tips table in dashboard */
  .round-table-wrap { overflow-x: auto; }
  .round-table th, .round-table td { font-size: 12px; padding: 6px 8px; text-align: center; }
  .round-table th:first-child, .round-table td:first-child { text-align: left; min-width: 160px; }
  .tip-correct { color: var(--green); font-weight: 700; }
  .tip-wrong { color: var(--red); }
  .tip-margin-bonus { color: var(--accent); font-weight: 900; }

  /* ADMIN */
  .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  @media (max-width: 900px) { .admin-grid { grid-template-columns: 1fr; } }

  .form-group { margin-bottom: 16px; }
  label { display: block; font-size: 12px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  input, select, textarea {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    color: var(--text); padding: 10px 12px; border-radius: 8px;
    font-family: var(--font-body); font-size: 14px;
    transition: border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent2); }
  select option { background: var(--surface); }

  .btn {
    background: var(--accent); color: #000;
    font-family: var(--font-display); font-size: 15px; font-weight: 900;
    letter-spacing: 1px; text-transform: uppercase;
    border: none; padding: 12px 24px; border-radius: 8px;
    cursor: pointer; transition: all 0.2s;
  }
  .btn:hover { background: #f5c842; transform: translateY(-1px); }
  .btn-secondary {
    background: var(--surface2); color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { background: var(--border); transform: none; }
  .btn-danger { background: var(--red); color: #fff; }
  .btn-danger:hover { background: #dc2626; }
  .btn-sm { padding: 6px 14px; font-size: 12px; }

  .game-row {
    display: grid; grid-template-columns: 1fr auto auto; gap: 12px;
    align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);
  }
  .game-row:last-child { border-bottom: none; }
  .game-label { font-weight: 600; font-size: 14px; }
  .game-label small { display: block; font-size: 11px; color: var(--muted); font-weight: 400; }

  .tip-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px; margin-top: 8px;
  }
  .tip-entry { display: flex; flex-direction: column; gap: 4px; }
  .tip-entry label { font-size: 10px; color: var(--muted); margin-bottom: 2px; }
  .tip-entry select { padding: 6px 8px; font-size: 12px; }

  .password-screen {
    max-width: 400px; margin: 80px auto; text-align: center;
  }
  .password-screen h2 {
    font-family: var(--font-display); font-size: 28px; font-weight: 900;
    text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px;
    color: var(--accent2);
  }
  .password-screen p { color: var(--muted); margin-bottom: 24px; }

  .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
  .alert-success { background: rgba(34,197,94,0.1); border: 1px solid var(--green); color: var(--green); }
  .alert-error { background: rgba(239,68,68,0.1); border: 1px solid var(--red); color: var(--red); }

  .tabs { display: flex; gap: 4px; margin-bottom: 20px; flex-wrap: wrap; }
  .tab {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); font-family: var(--font-display); font-size: 13px;
    font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
    padding: 6px 14px; border-radius: 6px; cursor: pointer; transition: all 0.2s;
  }
  .tab:hover { color: var(--text); }
  .tab.active { background: var(--accent); color: #000; border-color: var(--accent); }

  .magic-badge { background: rgba(240,180,41,0.2); border: 1px solid var(--accent); color: var(--accent); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; letter-spacing: 1px; }
  .origin-badge { background: rgba(56,189,248,0.2); border: 1px solid var(--accent2); color: var(--accent2); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; letter-spacing: 1px; }

  /* Scrollable table wrapper */
  .table-wrap { overflow-x: auto; }

  .empty-state { text-align: center; padding: 60px 24px; color: var(--muted); }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
  .empty-state p { font-size: 16px; }

  .setup-banner {
    background: rgba(56,189,248,0.1); border: 1px solid var(--accent2);
    border-radius: 8px; padding: 16px 20px; margin-bottom: 24px;
    font-size: 14px; color: var(--accent2);
  }

  /* Google Sheets config */
  .sheets-config { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
  .sheets-config p { font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.6; }
  .sheets-config code { background: var(--bg); padding: 2px 6px; border-radius: 4px; font-size: 11px; color: var(--accent2); }
</style>
</head>
<body>

<header>
  <div class="header-top">
    <div class="logo">Pegger's <span>Tipping</span> 2026<small>brought to you by James' Royal Pies ü•õü•ß</small></div>
  </div>
  <nav>
    <button class="active" onclick="showView('leaderboard')">Leaderboard</button>
    <button onclick="showView('dashboard')">Dashboard</button>
    <button onclick="showView('rounds')">Rounds</button>
    <button onclick="showView('rules')">Rules</button>
    <button onclick="showView('seasonbets')">Season Bets</button>
    <button onclick="showView('lms')">Last Man Standing</button>
    <button class="admin-btn" onclick="showView('admin')">Admin</button>
  </nav>
</header>

<div id="view-leaderboard" class="view active">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;">
    <div class="section-title">Season <span>Standings</span></div>
    <div id="current-round-badge" class="round-badge">Loading...</div>
  </div>
  <div class="card">
    <div class="table-wrap">
      <table id="leaderboard-table">
        <thead>
          <tr>
            <th>Pos</th>
            <th>Tipper</th>
            <th>Team</th>
            <th>Total</th>
            <th>Rnd</th>
            <th>¬±1wk</th>
            <th>¬±5wk</th>
            <th>Power</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body">
          <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:40px;">Loading data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="view-dashboard" class="view">
  <div class="section-title" style="margin-bottom:24px;">Dashboard <span>Overview</span></div>

  <div class="dash-grid" id="stat-cards"></div>

  <div class="card">
    <div class="card-title">Top 3 Podium</div>
    <div class="podium" id="podium"></div>
  </div>

  <div class="card">
    <div class="card-title">Score Progression (Cumulative)</div>
    <canvas id="progressChart" height="300"></canvas>
  </div>
</div>

<div id="view-rounds" class="view">
  <div class="section-title" style="margin-bottom:24px;">Round <span>Results</span></div>
  <div class="tabs" id="round-tabs"></div>
  <div id="round-detail"></div>
</div>

<div id="view-admin" class="view">
  <div id="admin-password-screen" class="password-screen">
    <h2>üîê Admin</h2>
    <p>Enter the admin password to manage rounds and results.</p>
    <div class="form-group">
      <input type="password" id="admin-pw-input" placeholder="Password" onkeydown="if(event.key==='Enter')checkPassword()">
    </div>
    <button class="btn" onclick="checkPassword()">Enter</button>
    <div id="pw-error" style="color:var(--red);margin-top:12px;font-size:14px;"></div>
  </div>

  <div id="admin-panel" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;">
      <div class="section-title">Admin <span>Panel</span></div>
      <button class="btn btn-secondary btn-sm" onclick="lockAdmin()">üîí Lock</button>
    </div>

    <div class="setup-banner" id="sheets-setup-banner">
      ‚öôÔ∏è <strong>Setup required:</strong> Configure your Google Sheets connection below before using the app.
    </div>

    <div class="admin-grid">
      <!-- Left: Sheets Config + Round Setup -->
      <div>
        <div class="card">
          <div class="card-title">Google Sheets Config</div>
          <div class="sheets-config">
            <p>To connect to Google Sheets:<br>
            1. Share your sheet publicly (view only)<br>
            2. Create a Google Apps Script web app to handle reads/writes<br>
            3. Paste the web app URL below<br><br>
            <strong>OR</strong> use the <strong>local mode</strong> (data stored in browser, export JSON to back up).
            </p>
          </div>
          <div class="form-group">
            <label>Mode</label>
            <select id="data-mode" onchange="updateMode()">
              <option value="local">Local (browser storage)</option>
              <option value="sheets">Google Sheets (Apps Script)</option>
            </select>
          </div>
          <div id="sheets-url-group" class="form-group" style="display:none;">
            <label>Apps Script Web App URL</label>
            <input type="url" id="sheets-url" placeholder="https://script.google.com/macros/s/...">
          </div>
          <button class="btn btn-secondary btn-sm" onclick="saveConfig()">Save Config</button>
        </div>

        <div class="card">
          <div class="card-title">New Round</div>
          <div class="form-group">
            <label>Round Name</label>
            <input type="text" id="new-round-name" placeholder="e.g. Round 3, Origin 1">
          </div>
          <div class="form-group">
            <label>Round Type</label>
            <select id="new-round-type">
              <option value="normal">Normal</option>
              <option value="magic">Magic Round (3x points)</option>
              <option value="vegas">Vegas Round (2x points)</option>
              <option value="origin">State of Origin</option>
            </select>
          </div>
          <div id="games-list">
            <div class="card-title" style="margin-top:8px;">Games</div>
            <div id="games-container"></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
            <button class="btn btn-secondary btn-sm" onclick="addGame()">+ Add Game</button>
            <button class="btn btn-sm" onclick="saveRound()">Save Round</button>
          </div>
        </div>
      </div>

      <!-- Right: Enter Tips + Results -->
      <div>
        <div class="card">
          <div class="card-title">Enter Tips</div>
          <div class="form-group">
            <label>Select Round</label>
            <select id="tips-round-select" onchange="loadTipsForm()">
              <option value="">-- Select Round --</option>
            </select>
          </div>
          <div id="tips-form"></div>
          <div id="tips-save-btn" style="display:none;margin-top:16px;">
            <button class="btn" onclick="saveTips()">Save Tips</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Enter Results</div>
          <div class="form-group">
            <label>Select Round</label>
            <select id="results-round-select" onchange="loadResultsForm()">
              <option value="">-- Select Round --</option>
            </select>
          </div>
          <div id="results-form"></div>
          <div id="results-save-btn" style="display:none;margin-top:16px;">
            <button class="btn" onclick="saveResults()">Save Results & Calculate Scores</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Data Management</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-secondary btn-sm" onclick="manualSyncFromSheets()">‚Üì Sync from Sheets</button>
        <button class="btn btn-secondary btn-sm" onclick="exportData()">Export JSON Backup</button>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('import-file').click()">Import JSON</button>
        <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
        <button class="btn btn-danger btn-sm" onclick="clearAllData()">Clear All Data</button>
      </div>
    </div>
  </div>
</div>

<div id="view-rules" class="view">
  <div class="section-title" style="margin-bottom:32px;">Competition <span>Rules</span></div>

  <div style="max-width:720px;display:flex;flex-direction:column;gap:20px;">

    <div class="card">
      <div class="card-title">üí∞ Prize Money</div>
      <table style="width:100%;">
        <tr><td style="padding:6px 0;font-weight:600;">Winner</td><td style="padding:6px 0;color:var(--accent);font-family:var(--font-display);font-size:18px;font-weight:900;">$600</td></tr>
        <tr><td style="padding:6px 0;">First Loser</td><td style="padding:6px 0;color:var(--muted);">$0</td></tr>
        <tr><td style="padding:6px 0;">All other losers</td><td style="padding:6px 0;color:var(--muted);">$0</td></tr>
      </table>
    </div>

    <div class="card">
      <div class="card-title">üé≤ Multis</div>
      <p style="line-height:1.8;font-size:14px;color:var(--text);">Each week the previous week's highest tipper can bet a $20 NRL (+Origin) multi, with all profits to go to end of season dinner.</p>
      <p style="line-height:1.8;font-size:14px;color:var(--muted);margin-top:8px;">Closest margin bet is the tie-breaker for multi bet the following week, in case of a tie.</p>
    </div>

    <div class="card">
      <div class="card-title">üèâ Season Leaderboard</div>
      <ul style="line-height:2;font-size:14px;list-style:none;display:flex;flex-direction:column;gap:6px;">
        <li>‚úÖ Each game is worth <strong>1 point</strong>. Tips must be submitted to WhatsApp prior to kickoff.</li>
        <li>‚≠ê There is one <strong>bonus point</strong> available for picking a perfect round.</li>
        <li>‚ùå If you tip against your team and they win, you <strong>lose a point</strong>.</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title">üìê Margin</div>
      <ul style="line-height:2;font-size:14px;list-style:none;display:flex;flex-direction:column;gap:6px;">
        <li>üåô The <strong>late Friday night game</strong> each week will be the margin game.</li>
        <li>üéØ An exact margin is a <strong>bonus 3 points</strong>.</li>
        <li>üìä Cumulative lowest margin score over the season worth <strong>10 points</strong> to the winner.</li>
        <li>üîó Closest to margin breaks tie-break for NRL multi bet the following week.</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title">‚ú® Bonus Rounds</div>
      <ul style="line-height:2;font-size:14px;list-style:none;display:flex;flex-direction:column;gap:6px;">
        <li><span class="magic-badge">2√ó</span> &nbsp;<strong>Vegas Games</strong> will be worth double points.</li>
        <li><span class="origin-badge">ORIGIN</span> &nbsp;Each Origin game worth <strong>2 points</strong>, tipped with margins (3pts) and MOTM (1pt).</li>
        <li><span class="magic-badge">3√ó</span> &nbsp;<strong>Magic Round</strong> tips will be worth triple points.</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title">üèÜ Last Man Standing</div>
      <ul style="line-height:2;font-size:14px;list-style:none;display:flex;flex-direction:column;gap:8px;">
        <li>From <strong>Round 6</strong>, each tipper makes an additional tip on a team they are confident will win from any game that round.</li>
        <li>Correct ‚Üí survive and earn points. Wrong or DQ ‚Üí you're out.</li>
        <li>You <strong>cannot tip the same team again</strong> for the rest of the competition. Tip must be in before kickoff of the relevant game. Breaking either rule = <strong>DQ</strong>.</li>
        <li>Points escalate as the season goes on:</li>
      </ul>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px;">
        <div style="background:var(--surface2);border-radius:8px;padding:14px;text-align:center;">
          <div style="font-family:var(--font-display);font-size:28px;font-weight:900;color:var(--accent);">1pt</div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px;">Rounds 6‚Äì11</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:14px;text-align:center;">
          <div style="font-family:var(--font-display);font-size:28px;font-weight:900;color:var(--accent);">2pts</div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px;">Rounds 12‚Äì17</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:14px;text-align:center;">
          <div style="font-family:var(--font-display);font-size:28px;font-weight:900;color:var(--accent);">3pts</div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px;">Rounds 18‚Äì23</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">üî• First Coach Down</div>
      <p style="font-size:14px;line-height:1.8;">First coach fired is worth <strong>3 points</strong>.</p>
    </div>

    <div class="card">
      <div class="card-title">üåü Dally M</div>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:4px;">
        <div style="text-align:center;background:var(--surface2);border-radius:8px;padding:12px;">
          <div style="font-family:var(--font-display);font-size:28px;font-weight:900;color:var(--accent);">5</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">1st</div>
        </div>
        <div style="text-align:center;background:var(--surface2);border-radius:8px;padding:12px;">
          <div style="font-family:var(--font-display);font-size:28px;font-weight:900;color:var(--accent);">4</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">2nd</div>
        </div>
        <div style="text-align:center;background:var(--surface2);border-radius:8px;padding:12px;">
          <div style="font-family:var(--font-display);font-size:28px;font-weight:900;color:var(--accent);">4</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">3rd</div>
        </div>
        <div style="text-align:center;background:var(--surface2);border-radius:8px;padding:12px;">
          <div style="font-family:var(--font-display);font-size:28px;font-weight:900;color:var(--accent);">2</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">4th</div>
        </div>
        <div style="text-align:center;background:var(--surface2);border-radius:8px;padding:12px;">
          <div style="font-family:var(--font-display);font-size:28px;font-weight:900;color:var(--accent);">1</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px;">5th</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ü™ú Ladder</div>
      <ul style="line-height:2;font-size:14px;list-style:none;display:flex;flex-direction:column;gap:6px;">
        <li>‚úÖ <strong>2 points</strong> for every team you get exactly right.</li>
        <li>„Ä∞Ô∏è <strong>1 point</strong> if you are within 1 place (up or down) of your chosen position.</li>
        <li>üéØ Total of <strong>34 points</strong> on offer ‚Äî choose wisely!</li>
      </ul>
    </div>

  </div>
</div>

<div id="view-seasonbets" class="view">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;">
    <div class="section-title">Season <span>Bets</span></div>
    <button class="admin-btn btn btn-sm" onclick="showSeasonBetsAdmin()" id="season-bets-edit-btn" style="display:none;">‚úèÔ∏è Edit Picks</button>
  </div>

  <!-- Supported Teams -->
  <div class="card" style="margin-bottom:20px;">
    <div class="card-title">üèâ Supported Teams</div>
    <div id="sb-teams-display"></div>
  </div>

  <!-- Combined: Dally M + Coach + Ladder -->
  <div class="card" style="margin-bottom:20px;">
    <div class="card-title">üåü Dally M ¬∑ üî• First Coach ¬∑ ü™ú Ladder</div>
    <div id="sb-combined-display"></div>
  </div>

  <!-- Admin entry panel (hidden by default) -->
  <div id="season-bets-admin" style="display:none;">
    <div class="card" style="margin-bottom:20px;">
      <div class="card-title">‚úèÔ∏è Enter Season Bets Data</div>

      <div style="margin-bottom:24px;">
        <div style="font-weight:700;margin-bottom:12px;font-size:14px;color:var(--accent2);">Dally M Picks (one pick per tipper)</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Tipper</th><th>Pick</th></tr></thead>
            <tbody id="dallym-input-rows"></tbody>
          </table>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <div style="font-weight:700;margin-bottom:12px;font-size:14px;color:var(--accent2);">First Coach Fired (pick per tipper)</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Tipper</th><th>Coach / Team</th></tr></thead>
            <tbody id="coach-input-rows"></tbody>
          </table>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <div style="font-weight:700;margin-bottom:12px;font-size:14px;color:var(--accent2);">Ladder Predictions (1st to 17th)</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Pos</th>
                ${Array.from({length:16},(_,i)=>`<th style="min-width:60px;">${TIPPERS[i]||''}</th>`).join('')}
              </tr>
            </thead>
            <tbody id="ladder-input-rows"></tbody>
          </table>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <div style="font-weight:700;margin-bottom:12px;font-size:14px;color:var(--accent2);">Actual Results (enter when known)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;flex-wrap:wrap;">
          <div class="form-group">
            <label>Dally M Winner (1st)</label>
            <input type="text" id="sb-result-dallym1" placeholder="Player name">
          </div>
          <div class="form-group">
            <label>Dally M 2nd</label>
            <input type="text" id="sb-result-dallym2" placeholder="Player name">
          </div>
          <div class="form-group">
            <label>Dally M 3rd</label>
            <input type="text" id="sb-result-dallym3" placeholder="Player name">
          </div>
          <div class="form-group">
            <label>Dally M 4th</label>
            <input type="text" id="sb-result-dallym4" placeholder="Player name">
          </div>
          <div class="form-group">
            <label>Dally M 5th</label>
            <input type="text" id="sb-result-dallym5" placeholder="Player name">
          </div>
          <div class="form-group">
            <label>First Coach Fired</label>
            <input type="text" id="sb-result-coach" placeholder="Coach / Team name">
          </div>
        </div>
        <div style="margin-top:8px;">
          <div style="font-weight:700;margin-bottom:8px;font-size:13px;color:var(--muted);">Final Ladder (1st to 17th)</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;" id="sb-result-ladder"></div>
        </div>
      </div>

      <button class="btn" onclick="saveSeasonBets()">Save Season Bets</button>
    </div>
  </div>
</div>

<div id="view-lms" class="view">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;">
    <div class="section-title">Last Man <span>Standing</span></div>
    <div id="lms-edit-btn" style="display:none;">
      <button class="admin-btn btn btn-sm" onclick="toggleLmsAdmin()">‚úèÔ∏è Enter LMS Picks</button>
    </div>
  </div>

  <!-- Status cards -->
  <div id="lms-status-cards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-bottom:24px;"></div>

  <!-- Round grid -->
  <div class="card" style="margin-bottom:20px;">
    <div class="card-title">Round by Round</div>
    <div class="table-wrap">
      <table id="lms-grid-table">
        <thead id="lms-grid-head"></thead>
        <tbody id="lms-grid-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Used teams -->
  <div class="card" style="margin-bottom:20px;">
    <div class="card-title">üö´ Used Teams</div>
    <div id="lms-used-teams"></div>
  </div>

  <!-- Admin entry -->
  <div id="lms-admin-panel" style="display:none;">
    <div class="card">
      <div class="card-title">‚úèÔ∏è Enter LMS Picks</div>
      <div class="form-group">
        <label>Round</label>
        <select id="lms-round-select" onchange="loadLmsForm()">
          <option value="">-- Select Round --</option>
        </select>
      </div>
      <div id="lms-entry-form"></div>
      <div id="lms-save-btn" style="display:none;margin-top:16px;">
        <button class="btn" onclick="saveLmsPicks()">Save LMS Picks</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMIN_PASSWORD = 'nrl2025'; // Change this!

const TIPPERS = ['Anish','Bev','David','George','Jacob','James','Jeremy','Jordan','Julian','Manettas','Pat','Phil','Ringo','Simon','Richard','Tim'];

const TIPPER_TEAMS = {
  'Anish': 'CB', 'Bev': 'SG', 'David': 'SR', 'George': 'RD',
  'Jacob': 'SS', 'James': 'SR', 'Jeremy': 'CB', 'Jordan': 'CB',
  'Julian': 'CB', 'Manettas': 'SE', 'Pat': 'CS', 'Phil': 'SE',
  'Ringo': 'BB', 'Simon': 'WT', 'Richard': 'NK', 'Tim': 'NK'
};

const TEAMS = {
  'BB':'Broncos','CR':'Raiders','CB':'Bulldogs','CS':'Sharks','GC':'Titans',
  'SE':'Sea Eagles','MS':'Storm','NZ':'Warriors','NK':'Knights','NQ':'Cowboys',
  'PE':'Eels','PP':'Panthers','SS':'Rabbitohs','SG':'Dragons','SR':'Roosters',
  'WT':'Wests Tigers','RD':'Dolphins'
};

const TEAM_LIST = Object.entries(TEAMS).map(([code, name]) => ({code, name}));

// Power ranking weights
const POWER_WEIGHTS = { rank: 0.5, change1: 0.3, change5: 0.2 };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let appData = {
  rounds: [],      // [{id, name, type, games, tips, results, scores}]
  config: { mode: 'local', sheetsUrl: '' }
};

let adminUnlocked = false;
let progressChart = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE ‚Äî local fallback + Google Sheets
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveToStorage() {
  localStorage.setItem('nrl_tipping_2026', JSON.stringify(appData));
  if (appData.config.mode === 'sheets' && appData.config.sheetsUrl) {
    saveToSheets();
  }
}

function loadFromStorage() {
  const raw = localStorage.getItem('nrl_tipping_2026');
  if (raw) {
    try { appData = JSON.parse(raw); } catch(e) {}
  }
}

async function saveToSheets() {
  if (!appData.config.sheetsUrl) return;
  try {
    const encoded = encodeURIComponent(JSON.stringify(appData));
    await fetch(appData.config.sheetsUrl + '?action=save&data=' + encoded);
  } catch(e) {
    console.warn('Sheets save failed:', e);
  }
}

async function loadFromSheets() {
  if (!appData.config || appData.config.mode !== 'sheets' || !appData.config.sheetsUrl) return;
  try {
    const url = appData.config.sheetsUrl + '?action=load&t=' + Date.now(); // cache-bust
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(e) { throw new Error('Invalid JSON from Sheets'); }
    if (data && Array.isArray(data.rounds)) {
      const localConfig = appData.config; // always preserve local config
      appData = data;
      appData.config = localConfig;
      localStorage.setItem('nrl_tipping_2026', JSON.stringify(appData));
    }
    // silently succeed ‚Äî no alert on auto-load, only on manual sync
  } catch(e) {
    console.warn('Sheets load failed:', e.message);
    // fall through to local storage data ‚Äî no alert so casual visitors don't see errors
  }
}

async function manualSyncFromSheets() {
  if (!appData.config || !appData.config.sheetsUrl) {
    showAlert('No Sheets URL configured.', 'error'); return;
  }
  showAlert('Syncing...', 'success');
  await loadFromSheets();
  renderLeaderboard();
  showAlert('Sync complete!', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCORING ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calculateRoundScores(round) {
  const scores = {};
  TIPPERS.forEach(t => scores[t] = 0);

  if (!round.results || !round.tips) return scores;

  const multiplier = round.type === 'magic' ? 3 : round.type === 'vegas' ? 2 : 1;

  // Track perfect round per tipper
  const perfect = {};
  TIPPERS.forEach(t => perfect[t] = true);

  round.games.forEach((game, idx) => {
    const result = round.results[idx];
    if (!result || !result.winner) return; // not yet played

    const isMarginGame = game.isMarginGame;
    const actualMargin = parseInt(result.margin) || 0;

    TIPPERS.forEach(tipper => {
      const tip = round.tips[tipper] && round.tips[tipper][idx];
      if (!tip) { perfect[tipper] = false; return; }

      // Correct tip
      if (tip.team === result.winner) {
        scores[tipper] += 1 * multiplier;

        // Exact margin bonus (3pts, not multiplied by magic round per rules interpretation)
        if (isMarginGame && tip.margin !== undefined && tip.margin !== '') {
          const tipMargin = parseInt(tip.margin);
          if (tipMargin === actualMargin) {
            scores[tipper] += 3;
          }
        }
      } else {
        perfect[tipper] = false;

        // Tip against your team and they win = -1pt
        const supportedTeam = TIPPER_TEAMS[tipper];
        if (result.winner === supportedTeam) {
          scores[tipper] -= 1;
        }
      }
    });
  });

  // Perfect round bonus
  TIPPERS.forEach(tipper => {
    const allPlayed = round.games.every((g, i) => round.results[i] && round.results[i].winner);
    if (allPlayed && perfect[tipper]) {
      scores[tipper] += 1 * multiplier;
    }
  });

  return scores;
}

function buildLeaderboard() {
  // Cumulative scores per round
  const cumulative = {};
  TIPPERS.forEach(t => cumulative[t] = []);

  const rounds = appData.rounds.filter(r => r.scores);

  rounds.forEach(round => {
    TIPPERS.forEach(tipper => {
      const prev = cumulative[tipper].length > 0 ? cumulative[tipper][cumulative[tipper].length-1] : 0;
      cumulative[tipper].push(prev + (round.scores[tipper] || 0));
    });
  });

  const n = rounds.length;
  if (n === 0) return [];

  // Current total
  const totals = {};
  TIPPERS.forEach(t => totals[t] = cumulative[t][n-1] || 0);

  // Rank by total
  const ranked = TIPPERS.slice().sort((a,b) => totals[b] - totals[a]);
  const rankMap = {};
  ranked.forEach((t, i) => rankMap[t] = i+1);

  // 1-week change
  const change1 = {};
  if (n >= 2) {
    const prevTotals = {};
    TIPPERS.forEach(t => prevTotals[t] = cumulative[t][n-2] || 0);
    const prevRanked = TIPPERS.slice().sort((a,b) => prevTotals[b] - prevTotals[a]);
    const prevRankMap = {};
    prevRanked.forEach((t, i) => prevRankMap[t] = i+1);
    TIPPERS.forEach(t => change1[t] = prevRankMap[t] - rankMap[t]); // positive = moved up
  } else {
    TIPPERS.forEach(t => change1[t] = 0);
  }

  // 5-week change
  const change5 = {};
  if (n >= 6) {
    const prev5Totals = {};
    TIPPERS.forEach(t => prev5Totals[t] = cumulative[t][n-6] || 0);
    const prev5Ranked = TIPPERS.slice().sort((a,b) => prev5Totals[b] - prev5Totals[a]);
    const prev5RankMap = {};
    prev5Ranked.forEach((t, i) => prev5RankMap[t] = i+1);
    TIPPERS.forEach(t => change5[t] = prev5RankMap[t] - rankMap[t]);
  } else {
    TIPPERS.forEach(t => change5[t] = 0);
  }

  // Power ranking (normalised)
  const nTippers = TIPPERS.length;
  const powerScores = {};
  TIPPERS.forEach(t => {
    const rankScore = (nTippers - rankMap[t]) / (nTippers - 1) * 100;
    const c1Score = Math.min(Math.max(change1[t], -15), 15);
    const c1Norm = (c1Score + 15) / 30 * 100;
    const c5Score = Math.min(Math.max(change5[t], -15), 15);
    const c5Norm = (c5Score + 15) / 30 * 100;
    powerScores[t] = rankScore * POWER_WEIGHTS.rank + c1Norm * POWER_WEIGHTS.change1 + c5Norm * POWER_WEIGHTS.change5;
  });

  // Week score
  const weekScore = {};
  TIPPERS.forEach(t => weekScore[t] = rounds[n-1].scores[t] || 0);

  // Add LMS points to totals
  TIPPERS.forEach(t => {
    const lmsPts = getLmsTotalPoints(t);
    totals[t] += lmsPts;
    // Also add to cumulative last entry
    if (cumulative[t].length > 0) cumulative[t][cumulative[t].length-1] += lmsPts;
  });

  return ranked.map(tipper => ({
    tipper,
    rank: rankMap[tipper],
    total: totals[tipper],
    weekScore: weekScore[tipper],
    change1: change1[tipper],
    change5: change5[tipper],
    power: powerScores[tipper],
    cumulative: cumulative[tipper],
    team: TIPPER_TEAMS[tipper]
  }));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEWS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  event.target.classList.add('active');
  renderView(name);
}

function renderView(name) {
  if (name === 'leaderboard') renderLeaderboard();
  if (name === 'dashboard') renderDashboard();
  if (name === 'rounds') renderRounds();
  if (name === 'seasonbets') renderSeasonBets();
  if (name === 'lms') renderLms();
  if (name === 'admin') renderAdmin();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEADERBOARD VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLeaderboard() {
  const lb = buildLeaderboard();
  const roundCount = appData.rounds.filter(r => r.scores).length;

  document.getElementById('current-round-badge').textContent =
    roundCount > 0 ? `After Round ${roundCount}` : 'No rounds played';

  const tbody = document.getElementById('leaderboard-body');

  if (lb.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="icon">üèâ</div><p>No rounds completed yet. Enter results in Admin to see standings.</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML = lb.map(row => {
    const c1html = row.change1 > 0
      ? `<span class="pos-up">‚ñ≤${row.change1}</span>`
      : row.change1 < 0
        ? `<span class="pos-down">‚ñº${Math.abs(row.change1)}</span>`
        : `<span class="pos-same">‚Äì</span>`;

    const c5html = row.change5 > 0
      ? `<span class="pos-up">‚ñ≤${row.change5}</span>`
      : row.change5 < 0
        ? `<span class="pos-down">‚ñº${Math.abs(row.change5)}</span>`
        : `<span class="pos-same">‚Äì</span>`;

    const rankClass = row.rank <= 3 ? `rank-${row.rank}` : '';
    const powerPct = Math.round(row.power);

    return `<tr>
      <td class="rank-cell ${rankClass}">${row.rank}</td>
      <td><div class="tipper-name">${row.tipper}</div></td>
      <td><span class="team-badge">${row.team}</span></td>
      <td class="score-cell">${row.total}</td>
      <td class="week-score">${row.weekScore}</td>
      <td>${c1html}</td>
      <td>${c5html}</td>
      <td>
        <div class="power-bar"><div class="power-fill" style="width:${powerPct}%"></div></div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px;">${powerPct}</div>
      </td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const lb = buildLeaderboard();
  const rounds = appData.rounds.filter(r => r.scores);

  // Stat cards
  const statCards = document.getElementById('stat-cards');
  if (lb.length === 0) {
    statCards.innerHTML = '<p style="color:var(--muted)">No data yet.</p>';
    document.getElementById('podium').innerHTML = '';
    if (progressChart) { progressChart.destroy(); progressChart = null; }
    return;
  }

  const leader = lb[0];
  const lastRound = rounds[rounds.length-1];
  const weekLeader = lb.slice().sort((a,b) => b.weekScore - a.weekScore)[0];

  statCards.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Season Leader</div>
      <div class="stat-value">${leader.tipper}</div>
      <div class="stat-sub">${leader.total} points</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Rounds Played</div>
      <div class="stat-value">${rounds.length}</div>
      <div class="stat-sub">of the 2026 season</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Last Round Best</div>
      <div class="stat-value">${weekLeader.tipper}</div>
      <div class="stat-sub">${weekLeader.weekScore} pts ‚Äî ${lastRound ? lastRound.name : ''}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Gap to Leader</div>
      <div class="stat-value">${lb.length > 1 ? leader.total - lb[1].total : 0}</div>
      <div class="stat-sub">points ahead of ${lb.length > 1 ? lb[1].tipper : '‚Äî'}</div>
    </div>
  `;

  // Podium
  const top3 = lb.slice(0, 3);
  const podiumOrder = top3.length >= 3 ? [top3[1], top3[0], top3[2]] : top3;
  const podiumClasses = top3.length >= 3 ? ['podium-2','podium-1','podium-3'] : ['podium-1','podium-2','podium-3'];
  const podiumNums = top3.length >= 3 ? [2,1,3] : [1,2,3];

  document.getElementById('podium').innerHTML = podiumOrder.map((p, i) => `
    <div class="podium-item ${podiumClasses[i]}">
      <div class="podium-name">${p.tipper}</div>
      <div class="podium-score">${p.total} pts</div>
      <div class="podium-block">${podiumNums[i]}</div>
    </div>
  `).join('');

  // Progress chart
  const ctx = document.getElementById('progressChart');
  if (progressChart) { progressChart.destroy(); }

  const colors = ['#f0b429','#38bdf8','#22c55e','#f87171','#a78bfa','#fb923c',
                  '#34d399','#60a5fa','#f472b6','#facc15','#4ade80','#e879f9',
                  '#38bdf8','#fb7185','#a3e635','#94a3b8'];

  const labels = rounds.map(r => r.name);

  const datasets = lb.map((row, i) => ({
    label: row.tipper,
    data: row.cumulative,
    borderColor: colors[i % colors.length],
    backgroundColor: 'transparent',
    borderWidth: row.rank === 1 ? 3 : 1.5,
    pointRadius: 3,
    tension: 0.3
  }));

  progressChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#94a3b8', font: { family: 'Barlow', size: 12 }, boxWidth: 16, padding: 12 } }
      },
      scales: {
        x: { ticks: { color: '#64748b' }, grid: { color: '#1f2d45' } },
        y: { ticks: { color: '#64748b' }, grid: { color: '#1f2d45' } }
      }
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROUNDS VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRounds() {
  const tabs = document.getElementById('round-tabs');
  const detail = document.getElementById('round-detail');

  if (appData.rounds.length === 0) {
    tabs.innerHTML = '';
    detail.innerHTML = `<div class="empty-state"><div class="icon">üìã</div><p>No rounds yet. Create rounds in Admin.</p></div>`;
    return;
  }

  tabs.innerHTML = appData.rounds.map((r, i) =>
    `<div class="tab ${i===0?'active':''}" onclick="showRoundDetail(${i}, this)">${r.name}</div>`
  ).join('');

  showRoundDetailById(0, detail);
}

function showRoundDetail(idx, el) {
  document.querySelectorAll('#round-tabs .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  showRoundDetailById(idx, document.getElementById('round-detail'));
}

function showRoundDetailById(idx, container) {
  const round = appData.rounds[idx];
  if (!round) return;

  const vegasBadge = '<span style="background:rgba(168,85,247,0.2);border:1px solid #a855f7;color:#a855f7;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;letter-spacing:1px;">üé∞ VEGAS ROUND</span>';
  const typeBadge = round.type === 'magic'
    ? '<span class="magic-badge">‚ú® MAGIC ROUND</span>'
    : round.type === 'vegas'
      ? vegasBadge
      : round.type === 'origin'
      ? '<span class="origin-badge">‚ö° STATE OF ORIGIN</span>'
      : '';

  let html = `<div class="card">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
      <div class="card-title" style="margin-bottom:0;">${round.name}</div>
      ${typeBadge}
      ${round.scores ? '<span style="color:var(--green);font-size:12px;font-weight:700;">‚úì SCORED</span>' : '<span style="color:var(--muted);font-size:12px;">‚è≥ Pending results</span>'}
    </div>
    <div class="round-table-wrap">
    <table class="round-table">
      <thead>
        <tr>
          <th>Game</th>
          <th>Result</th>
          ${TIPPERS.map(t => `<th>${t.substring(0,4)}</th>`).join('')}
        </tr>
      </thead>
      <tbody>`;

  round.games.forEach((game, gi) => {
    const result = round.results && round.results[gi];
    const winner = result && result.winner;
    const margin = result && result.margin;

    html += `<tr>
      <td style="text-align:left;">
        <strong>${game.home} v ${game.away}</strong>
        ${game.isMarginGame ? '<br><small style="color:var(--accent)">Margin Game</small>' : ''}
      </td>
      <td>
        ${winner ? `<strong>${winner}</strong>${margin !== undefined ? `<br><small>${margin > 0 ? '+' : ''}${margin}</small>` : ''}` : '<span style="color:var(--muted)">TBD</span>'}
      </td>`;

    TIPPERS.forEach(tipper => {
      const tip = round.tips && round.tips[tipper] && round.tips[tipper][gi];
      const tipTeam = tip && tip.team;
      const tipMargin = tip && tip.margin;

      let cls = '';
      if (winner && tipTeam) {
        cls = tipTeam === winner ? 'tip-correct' : 'tip-wrong';
      }
      html += `<td class="${cls}">${tipTeam || '‚Äì'}${game.isMarginGame && tipMargin !== undefined && tipMargin !== '' ? `<br><small>${tipMargin}</small>` : ''}</td>`;
    });

    html += '</tr>';
  });

  // Round totals row
  if (round.scores) {
    const sorted = TIPPERS.map(t => t);
    html += `<tr style="border-top:2px solid var(--border);">
      <td><strong>Points</strong></td>
      <td></td>
      ${TIPPERS.map(t => `<td><strong>${round.scores[t] || 0}</strong></td>`).join('')}
    </tr>`;
  }

  html += '</tbody></table></div></div>';
  container.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAdmin() {
  if (!adminUnlocked) {
    document.getElementById('admin-password-screen').style.display = 'block';
    document.getElementById('admin-panel').style.display = 'none';
  } else {
    document.getElementById('admin-password-screen').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';
    document.getElementById('season-bets-edit-btn').style.display = 'inline-block';
    document.getElementById('lms-edit-btn').style.display = 'block';
    populateAdminRoundSelects();
    renderGamesList();
  }
}

function checkPassword() {
  const pw = document.getElementById('admin-pw-input').value;
  if (pw === ADMIN_PASSWORD) {
    adminUnlocked = true;
    document.getElementById('pw-error').textContent = '';
    renderAdmin();
  } else {
    document.getElementById('pw-error').textContent = 'Incorrect password.';
  }
}

function lockAdmin() {
  adminUnlocked = false;
  document.getElementById('admin-pw-input').value = '';
  renderAdmin();
}

function updateMode() {
  const mode = document.getElementById('data-mode').value;
  document.getElementById('sheets-url-group').style.display = mode === 'sheets' ? 'block' : 'none';
}

function saveConfig() {
  appData.config.mode = document.getElementById('data-mode').value;
  appData.config.sheetsUrl = document.getElementById('sheets-url').value;
  saveToStorage();
  document.getElementById('sheets-setup-banner').style.display = 'none';
  showAlert('Config saved!', 'success');
}

// Games builder
let gamesList = [];

function renderGamesList() {
  const container = document.getElementById('games-container');
  if (gamesList.length === 0) {
    container.innerHTML = '<p style="color:var(--muted);font-size:13px;margin-bottom:8px;">No games added yet.</p>';
    return;
  }

  container.innerHTML = gamesList.map((g, i) => `
    <div class="game-row">
      <div>
        <div class="game-label">${g.home || '?'} v ${g.away || '?'}</div>
        <div style="font-size:11px;color:var(--muted);">${g.isMarginGame ? '‚≠ê Margin game' : ''}</div>
      </div>
      <label style="font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer;">
        <input type="checkbox" ${g.isMarginGame ? 'checked' : ''} onchange="toggleMarginGame(${i}, this.checked)" style="width:auto;">
        Margin
      </label>
      <button class="btn btn-secondary btn-sm" onclick="removeGame(${i})">‚úï</button>
    </div>
  `).join('');
}

function addGame() {
  // Prompt-style inline add
  const container = document.getElementById('games-container');
  const div = document.createElement('div');
  div.style.cssText = 'background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;';
  div.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:end;">
      <div>
        <label>Home Team</label>
        <select id="new-home">
          ${TEAM_LIST.map(t => `<option value="${t.code}">${t.name}</option>`).join('')}
        </select>
      </div>
      <div>
        <label>Away Team</label>
        <select id="new-away">
          ${TEAM_LIST.map(t => `<option value="${t.code}">${t.name}</option>`).join('')}
        </select>
      </div>
      <button class="btn btn-sm" onclick="confirmAddGame(this)">Add</button>
    </div>
  `;
  container.appendChild(div);
}

function confirmAddGame(btn) {
  const parent = btn.closest('div').parentElement;
  const home = parent.querySelector('#new-home').value;
  const away = parent.querySelector('#new-away').value;
  gamesList.push({ home, away, isMarginGame: false });
  parent.remove();
  renderGamesList();
}

function toggleMarginGame(idx, val) {
  // Clear all margin games first, then set this one
  gamesList.forEach(g => g.isMarginGame = false);
  gamesList[idx].isMarginGame = val;
  renderGamesList();
}

function removeGame(idx) {
  gamesList.splice(idx, 1);
  renderGamesList();
}

function saveRound() {
  const name = document.getElementById('new-round-name').value.trim();
  const type = document.getElementById('new-round-type').value;
  if (!name) { showAlert('Please enter a round name.', 'error'); return; }
  if (gamesList.length === 0) { showAlert('Please add at least one game.', 'error'); return; }

  const round = {
    id: Date.now(),
    name, type,
    games: JSON.parse(JSON.stringify(gamesList)),
    tips: null,
    results: null,
    scores: null
  };

  appData.rounds.push(round);
  saveToStorage();
  gamesList = [];
  document.getElementById('new-round-name').value = '';
  renderGamesList();
  populateAdminRoundSelects();
  showAlert(`Round "${name}" saved!`, 'success');
}

function populateAdminRoundSelects() {
  ['tips-round-select','results-round-select'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">-- Select Round --</option>' +
      appData.rounds.map((r,i) => `<option value="${i}">${r.name}</option>`).join('');
  });
}

// Tips form
function loadTipsForm() {
  const idx = document.getElementById('tips-round-select').value;
  const container = document.getElementById('tips-form');
  const saveBtn = document.getElementById('tips-save-btn');
  if (idx === '') { container.innerHTML = ''; saveBtn.style.display = 'none'; return; }

  const round = appData.rounds[idx];
  const existingTips = round.tips || {};

  let html = '';
  round.games.forEach((game, gi) => {
    html += `<div style="margin-bottom:20px;">
      <div style="font-weight:700;margin-bottom:8px;font-size:15px;">
        Game ${gi+1}: ${game.home} v ${game.away}
        ${game.isMarginGame ? '<span class="magic-badge" style="margin-left:8px;">Margin Game</span>' : ''}
      </div>
      <div class="tip-grid">`;

    TIPPERS.forEach(tipper => {
      const existingTip = existingTips[tipper] && existingTips[tipper][gi];
      const selectedTeam = existingTip ? existingTip.team : '';
      const selectedMargin = existingTip ? existingTip.margin : '';

      html += `<div class="tip-entry">
        <label>${tipper}</label>
        <select id="tip-${gi}-${tipper}-team">
          <option value="">‚Äì</option>
          <option value="${game.home}" ${selectedTeam===game.home?'selected':''}>${game.home}</option>
          <option value="${game.away}" ${selectedTeam===game.away?'selected':''}>${game.away}</option>
        </select>
        ${game.isMarginGame ? `<input type="number" id="tip-${gi}-${tipper}-margin" placeholder="Margin" value="${selectedMargin}" style="margin-top:4px;">` : ''}
      </div>`;
    });

    html += '</div></div>';
  });

  container.innerHTML = html;
  saveBtn.style.display = 'block';
}

function saveTips() {
  const idx = document.getElementById('tips-round-select').value;
  if (idx === '') return;
  const round = appData.rounds[idx];

  const tips = {};
  TIPPERS.forEach(tipper => {
    tips[tipper] = round.games.map((game, gi) => {
      const team = document.getElementById(`tip-${gi}-${tipper}-team`)?.value || '';
      const marginEl = document.getElementById(`tip-${gi}-${tipper}-margin`);
      const margin = marginEl ? marginEl.value : undefined;
      return { team, margin };
    });
  });

  round.tips = tips;
  saveToStorage();
  showAlert('Tips saved!', 'success');
}

// Results form
function loadResultsForm() {
  const idx = document.getElementById('results-round-select').value;
  const container = document.getElementById('results-form');
  const saveBtn = document.getElementById('results-save-btn');
  if (idx === '') { container.innerHTML = ''; saveBtn.style.display = 'none'; return; }

  const round = appData.rounds[idx];
  const existingResults = round.results || [];

  let html = '';
  round.games.forEach((game, gi) => {
    const existing = existingResults[gi] || {};
    html += `<div class="game-row">
      <div>
        <div class="game-label">${game.home} v ${game.away}</div>
        ${game.isMarginGame ? '<small style="color:var(--accent)">Margin game</small>' : ''}
      </div>
      <select id="result-${gi}-winner" style="width:120px;">
        <option value="">‚Äì</option>
        <option value="${game.home}" ${existing.winner===game.home?'selected':''}>${game.home}</option>
        <option value="${game.away}" ${existing.winner===game.away?'selected':''}>${game.away}</option>
      </select>
      ${game.isMarginGame ? `<input type="number" id="result-${gi}-margin" placeholder="Margin" value="${existing.margin||''}" style="width:90px;">` : '<div></div>'}
    </div>`;
  });

  container.innerHTML = html;
  saveBtn.style.display = 'block';
}

function saveResults() {
  const idx = document.getElementById('results-round-select').value;
  if (idx === '') return;
  const round = appData.rounds[idx];

  round.results = round.games.map((game, gi) => {
    const winner = document.getElementById(`result-${gi}-winner`)?.value || '';
    const marginEl = document.getElementById(`result-${gi}-margin`);
    const margin = marginEl ? parseInt(marginEl.value) || 0 : undefined;
    return { winner, margin };
  });

  // Calculate scores
  round.scores = calculateRoundScores(round);
  saveToStorage();
  showAlert('Results saved and scores calculated!', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportData() {
  const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `nrl-tipping-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      appData = JSON.parse(e.target.result);
      saveToStorage();
      showAlert('Data imported successfully!', 'success');
      renderAdmin();
    } catch(err) {
      showAlert('Invalid JSON file.', 'error');
    }
  };
  reader.readAsText(file);
}

function clearAllData() {
  if (!confirm('Are you sure? This will delete all rounds, tips and results.')) return;
  appData = { rounds: [], config: appData.config };
  saveToStorage();
  showAlert('All data cleared.', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAlert(msg, type) {
  const existing = document.querySelector('.floating-alert');
  if (existing) existing.remove();
  const div = document.createElement('div');
  div.className = `alert alert-${type} floating-alert`;
  div.style.cssText = 'position:fixed;top:80px;right:24px;z-index:999;max-width:320px;box-shadow:0 4px 24px rgba(0,0,0,0.4)';
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LAST MAN STANDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getLmsData() {
  return appData.lms || {};
}

function getLmsPointValue(roundName) {
  const match = roundName.match(/Rd\s*(\d+)/i);
  if (!match) return 1;
  const num = parseInt(match[1]);
  if (num >= 18) return 3;
  if (num >= 12) return 2;
  return 1;
}

function getLmsTipperStatus(tipper) {
  // Returns { alive: bool, points: int, usedTeams: [], rounds: {roundId: {pick, result}} }
  const lms = getLmsData();
  const status = { alive: true, points: 0, usedTeams: [], rounds: {} };
  
  // Get all LMS rounds in order
  const lmsRounds = appData.rounds.filter(r => lms[r.id]);
  lmsRounds.forEach(round => {
    const entry = lms[round.id] && lms[round.id][tipper];
    if (!entry) return;
    status.rounds[round.id] = entry;
    if (entry.pick) status.usedTeams.push(entry.pick);
    if (!status.alive) return; // already eliminated
    if (entry.result === 'correct') status.points += getLmsPointValue(round.name);
    else if (entry.result === 'wrong') status.alive = false;
  });
  return status;
}

function renderLms() {
  if (adminUnlocked) {
    document.getElementById('lms-edit-btn').style.display = 'block';
    populateLmsRoundSelect();
  }

  const lms = getLmsData();
  const lmsRounds = appData.rounds.filter(r => lms[r.id] || r.id); // show all rounds from R6 onwards that have LMS data
  const lmsRoundsWithData = appData.rounds.filter(r => lms[r.id]);

  // Status cards
  const cardsDiv = document.getElementById('lms-status-cards');
  cardsDiv.innerHTML = TIPPERS.map(t => {
    const status = getLmsTipperStatus(t);
    const borderColor = status.alive ? 'var(--green)' : 'var(--border)';
    const statusLabel = status.alive ? '‚úÖ Alive' : '‚ùå Out';
    const statusColor = status.alive ? 'var(--green)' : 'var(--red)';
    return `<div style="background:var(--surface);border:1px solid ${borderColor};border-radius:10px;padding:14px;text-align:center;">
      <div style="font-family:var(--font-display);font-size:16px;font-weight:700;text-transform:uppercase;">${t}</div>
      <div style="font-size:12px;color:${statusColor};margin-top:4px;font-weight:700;">${statusLabel}</div>
      <div style="font-family:var(--font-display);font-size:28px;font-weight:900;color:var(--accent);margin-top:4px;">${status.points}</div>
      <div style="font-size:11px;color:var(--muted);">pts</div>
    </div>`;
  }).join('');

  // Round grid
  const thead = document.getElementById('lms-grid-head');
  const tbody = document.getElementById('lms-grid-body');

  if (lmsRoundsWithData.length === 0) {
    thead.innerHTML = '<tr><th>Round</th>' + TIPPERS.map(t => `<th style="font-size:11px;">${t.substring(0,5)}</th>`).join('') + '</tr>';
    tbody.innerHTML = `<tr><td colspan="${TIPPERS.length+1}" class="empty-state" style="padding:30px;text-align:center;color:var(--muted);">No LMS rounds entered yet. Starts from Round 6.</td></tr>`;
  } else {
    thead.innerHTML = '<tr><th>Round</th>' + TIPPERS.map(t => `<th style="font-size:11px;">${t.substring(0,5)}</th>`).join('') + '<th>Active</th></tr>';
    
    // Track alive status as we go
    const alive = {};
    TIPPERS.forEach(t => alive[t] = true);

    tbody.innerHTML = lmsRoundsWithData.map(round => {
      const roundLms = lms[round.id] || {};
      let activeCount = 0;
      const cells = TIPPERS.map(t => {
        const entry = roundLms[t];
        if (!alive[t]) return '<td style="color:var(--border);">‚Äì</td>';
        if (!entry || !entry.pick) return '<td style="color:var(--muted);">‚Äì</td>';
        
        let bg = '', label = entry.pick;
        if (entry.result === 'correct') { bg = 'color:var(--green);font-weight:700;'; activeCount++; }
        else if (entry.result === 'wrong') { bg = 'color:var(--red);'; alive[t] = false; }
        else { activeCount++; } // pending result
        
        return `<td style="font-size:11px;${bg}">${label}</td>`;
      });

      // Update alive after processing wrong results
      TIPPERS.forEach(t => {
        const entry = roundLms[t];
        if (entry && entry.result === 'wrong') alive[t] = false;
      });

      return `<tr>
        <td style="font-weight:700;white-space:nowrap;">${round.name}</td>
        ${cells.join('')}
        <td style="color:var(--accent2);font-weight:700;">${activeCount}</td>
      </tr>`;
    }).join('');
  }

  // Points row
  if (lmsRoundsWithData.length > 0) {
    const ptRow = document.createElement('tr');
    ptRow.style.borderTop = '2px solid var(--border)';
    ptRow.innerHTML = '<td><strong>Pts</strong></td>' +
      TIPPERS.map(t => {
        const s = getLmsTipperStatus(t);
        return `<td><strong style="color:var(--accent);">${s.points}</strong></td>`;
      }).join('') + '<td></td>';
    document.getElementById('lms-grid-body').appendChild(ptRow);
  }

  // Used teams
  const usedDiv = document.getElementById('lms-used-teams');
  usedDiv.innerHTML = '<div style="display:flex;flex-direction:column;gap:10px;">' +
    TIPPERS.map(t => {
      const status = getLmsTipperStatus(t);
      const used = status.usedTeams;
      return `<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <div style="font-family:var(--font-display);font-weight:700;font-size:13px;text-transform:uppercase;width:80px;">${t}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          ${used.length > 0 
            ? used.map(team => `<span class="team-badge" style="text-decoration:line-through;opacity:0.6;">${team}</span>`).join('')
            : '<span style="color:var(--muted);font-size:12px;">None used</span>'}
        </div>
      </div>`;
    }).join('') + '</div>';
}

function toggleLmsAdmin() {
  const panel = document.getElementById('lms-admin-panel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function populateLmsRoundSelect() {
  const sel = document.getElementById('lms-round-select');
  sel.innerHTML = '<option value="">-- Select Round --</option>' +
    appData.rounds.map((r, i) => `<option value="${i}">${r.name}</option>`).join('');
}

function loadLmsForm() {
  const idx = document.getElementById('lms-round-select').value;
  const form = document.getElementById('lms-entry-form');
  const saveBtn = document.getElementById('lms-save-btn');
  if (idx === '') { form.innerHTML = ''; saveBtn.style.display = 'none'; return; }

  const round = appData.rounds[idx];
  const lms = getLmsData();
  const existing = (lms[round.id] || {});

  // Figure out who is still alive going into this round
  const lmsRoundsBefore = appData.rounds.slice(0, parseInt(idx)).filter(r => lms[r.id]);
  const aliveMap = {};
  TIPPERS.forEach(t => aliveMap[t] = true);
  lmsRoundsBefore.forEach(r => {
    TIPPERS.forEach(t => {
      const e = lms[r.id] && lms[r.id][t];
      if (e && e.result === 'wrong') aliveMap[t] = false;
    });
  });

  // Used teams per tipper
  const usedMap = {};
  TIPPERS.forEach(t => {
    usedMap[t] = [];
    lmsRoundsBefore.forEach(r => {
      const e = lms[r.id] && lms[r.id][t];
      if (e && e.pick) usedMap[t].push(e.pick);
    });
  });

  let html = '<div style="margin-top:12px;">';
  TIPPERS.forEach(t => {
    const alive = aliveMap[t];
    const used = usedMap[t];
    const ex = existing[t] || {};
    const availableTeams = TEAM_LIST.filter(tm => !used.includes(tm.code));

    html += `<div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:12px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);">
      <div style="font-family:var(--font-display);font-weight:700;font-size:14px;text-transform:uppercase;${!alive?'opacity:0.4;':''}">${t}${!alive?' ‚ùå':''}</div>
      <select id="lms-pick-${t}" ${!alive?'disabled':''} style="padding:6px;font-size:13px;">
        <option value="">‚Äì No pick ‚Äì</option>
        ${availableTeams.map(tm => `<option value="${tm.code}" ${ex.pick===tm.code?'selected':''}>${tm.name} (${tm.code})</option>`).join('')}
      </select>
      <select id="lms-result-${t}" ${!alive?'disabled':''} style="padding:6px;font-size:13px;">
        <option value="" ${!ex.result?'selected':''}>‚Äì Pending ‚Äì</option>
        <option value="correct" ${ex.result==='correct'?'selected':''}>‚úÖ Correct</option>
        <option value="wrong" ${ex.result==='wrong'?'selected':''}>‚ùå Wrong / Out</option>
      </select>
    </div>`;
  });
  html += '</div>';

  form.innerHTML = html;
  saveBtn.style.display = 'block';
}

function saveLmsPicks() {
  const idx = document.getElementById('lms-round-select').value;
  if (idx === '') return;
  const round = appData.rounds[idx];
  if (!appData.lms) appData.lms = {};

  const roundData = {};
  TIPPERS.forEach(t => {
    const pick = document.getElementById(`lms-pick-${t}`)?.value || '';
    const result = document.getElementById(`lms-result-${t}`)?.value || '';
    if (pick || result) roundData[t] = { pick, result };
  });

  appData.lms[round.id] = roundData;
  saveToStorage();
  renderLms();
  showAlert('LMS picks saved!', 'success');
}

function getLmsTotalPoints(tipper) {
  return getLmsTipperStatus(tipper).points;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEASON BETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LADDER_POSITIONS = ['1st','2nd','3rd','4th','5th','6th','7th','8th','9th','10th','11th','12th','13th','14th','15th','16th','17th'];
const DALLYM_POINTS = [5,4,3,2,1];

function renderSeasonBets() {
  if (adminUnlocked) document.getElementById('season-bets-edit-btn').style.display = 'inline-block';

  const sb = appData.seasonBets || {};
  const results = sb.results || {};
  const dallyPicks = sb.dallyM || {};
  const coachPicks = sb.coach || {};
  const ladderPicks = sb.ladder || {};

  // --- Supported Teams ---
  const teamsDiv = document.getElementById('sb-teams-display');
  teamsDiv.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;">
    ${TIPPERS.map(t => `
      <div style="background:var(--surface2);border-radius:8px;padding:12px;text-align:center;">
        <div style="font-family:var(--font-display);font-size:16px;font-weight:700;text-transform:uppercase;">${t}</div>
        <div style="margin-top:6px;"><span class="team-badge">${TIPPER_TEAMS[t] || '‚Äì'}</span></div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px;">${TEAMS[TIPPER_TEAMS[t]] || ''}</div>
      </div>`).join('')}
  </div>`;

  // --- Combined Season Bets Table ---
  const dallyResult = results.dallyM || ''; // actual winner
  const dallyTop5 = [results.dallym1,results.dallym2,results.dallym3,results.dallym4,results.dallym5].map(s => (s||'').toLowerCase().trim());
  const coachResult = (results.coach || '').toLowerCase().trim();
  const ladderResult = results.ladder || [];
  const hasLadder = ladderResult.filter(Boolean).length > 0;
  const hasDally = dallyTop5.filter(Boolean).length > 0;
  const hasCoach = !!coachResult;

  // Scores per tipper
  const dallyScores = {};
  const coachScores = {};
  const ladderScores = {};
  TIPPERS.forEach(t => {
    dallyScores[t] = 0;
    coachScores[t] = 0;
    ladderScores[t] = 0;
  });

  if (hasDally) {
    TIPPERS.forEach(t => {
      const pick = (dallyPicks[t] || '').toLowerCase().trim();
      const idx = dallyTop5.indexOf(pick);
      if (idx !== -1) dallyScores[t] = DALLYM_POINTS[idx];
    });
  }
  if (hasCoach) {
    TIPPERS.forEach(t => {
      if ((coachPicks[t] || '').toLowerCase().trim() === coachResult) coachScores[t] = 3;
    });
  }
  if (hasLadder) {
    TIPPERS.forEach(t => {
      (ladderPicks[t] || []).forEach((pick, idx) => {
        const actualPos = ladderResult.indexOf(pick);
        if (actualPos === idx) ladderScores[t] += 2;
        else if (Math.abs(actualPos - idx) === 1 && actualPos !== -1) ladderScores[t] += 1;
      });
    });
  }

  let html = '<div class="table-wrap"><table><thead><tr><th style="min-width:120px;">Category</th>';
  TIPPERS.forEach(t => html += `<th style="min-width:65px;font-size:11px;">${t.substring(0,6)}</th>`);
  html += '</tr></thead><tbody>';

  // Dally M row
  html += '<tr style="background:rgba(240,180,41,0.05)"><td><strong style="color:var(--accent);">üåü Dally M</strong><br><small style="color:var(--muted);">5/4/3/2/1 pts</small></td>';
  TIPPERS.forEach(t => {
    const pick = dallyPicks[t] || '‚Äì';
    const score = dallyScores[t];
    const cls = hasDally ? (score > 0 ? 'tip-correct' : 'tip-wrong') : '';
    html += `<td class="${cls}">${pick}${hasDally && score > 0 ? `<br><small>+${score}pt</small>` : ''}</td>`;
  });
  html += '</tr>';

  // Dally M score row
  if (hasDally) {
    html += '<tr><td style="color:var(--muted);font-size:12px;">Dally M Score</td>';
    TIPPERS.forEach(t => html += `<td><strong>${dallyScores[t]}</strong></td>`);
    html += '</tr>';
    html += `<tr><td colspan="${TIPPERS.length+1}" style="font-size:11px;color:var(--muted);padding:4px 12px;">Top 5: ${[results.dallym1,results.dallym2,results.dallym3,results.dallym4,results.dallym5].filter(Boolean).join(', ')}</td></tr>`;
  }

  // Spacer
  html += `<tr><td colspan="${TIPPERS.length+1}" style="padding:4px;background:var(--border);"></td></tr>`;

  // First Coach row
  html += '<tr style="background:rgba(239,68,68,0.05)"><td><strong style="color:var(--red);">üî• First Coach</strong><br><small style="color:var(--muted);">3 pts</small></td>';
  TIPPERS.forEach(t => {
    const pick = coachPicks[t] || '‚Äì';
    const correct = hasCoach && (pick.toLowerCase().trim() === coachResult);
    html += `<td class="${correct ? 'tip-correct' : hasCoach ? 'tip-wrong' : ''}">${pick}${correct ? '<br><small>+3pt</small>' : ''}</td>`;
  });
  html += '</tr>';
  if (hasCoach) {
    html += '<tr><td style="color:var(--muted);font-size:12px;">Coach Score</td>';
    TIPPERS.forEach(t => html += `<td><strong>${coachScores[t]}</strong></td>`);
    html += `</tr><tr><td colspan="${TIPPERS.length+1}" style="font-size:11px;color:var(--muted);padding:4px 12px;">First fired: ${results.coach}</td></tr>`;
  }

  // Spacer
  html += `<tr><td colspan="${TIPPERS.length+1}" style="padding:4px;background:var(--border);"></td></tr>`;

  // Ladder rows
  html += `<tr><td colspan="${TIPPERS.length+1}" style="padding:8px 12px;"><strong style="color:var(--accent2);">ü™ú Ladder Predictions</strong> <small style="color:var(--muted);">2pts exact, 1pt ¬±1 place ‚Äî 34pts available</small></td></tr>`;
  LADDER_POSITIONS.forEach((pos, idx) => {
    html += `<tr><td><strong>${pos}</strong>${hasLadder && ladderResult[idx] ? `<br><small style="color:var(--muted);">${ladderResult[idx]}</small>` : ''}</td>`;
    TIPPERS.forEach(t => {
      const pick = (ladderPicks[t] || [])[idx] || '‚Äì';
      let cls = '';
      if (hasLadder && pick !== '‚Äì') {
        const actualPos = ladderResult.indexOf(pick);
        if (actualPos === idx) cls = 'tip-correct';
        else if (Math.abs(actualPos - idx) === 1 && actualPos !== -1) cls = 'pos-same';
        else if (actualPos !== -1) cls = 'tip-wrong';
      }
      html += `<td class="${cls}" style="font-size:11px;">${pick}</td>`;
    });
    html += '</tr>';
  });

  // Ladder score row
  html += '<tr style="border-top:2px solid var(--border);"><td><strong>Ladder Score</strong></td>';
  TIPPERS.forEach(t => html += `<td><strong>${hasLadder ? ladderScores[t] : '‚Äì'}</strong></td>`);
  html += '</tr>';

  // Grand total row
  html += '<tr style="background:rgba(240,180,41,0.08);border-top:2px solid var(--accent);"><td><strong style="color:var(--accent);">Total</strong></td>';
  TIPPERS.forEach(t => {
    const total = dallyScores[t] + coachScores[t] + ladderScores[t];
    html += `<td><strong style="color:var(--accent);">${total > 0 || (hasDally && hasCoach && hasLadder) ? total : '‚Äì'}</strong></td>`;
  });
  html += '</tr>';

  html += '</tbody></table></div>';
  document.getElementById('sb-combined-display').innerHTML = html;
}

function showSeasonBetsAdmin() {
  const panel = document.getElementById('season-bets-admin');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  if (panel.style.display === 'block') buildSeasonBetsForm();
}

function buildSeasonBetsForm() {
  const sb = appData.seasonBets || {};
  const coachPicks = sb.coach || {};
  const ladderPicks = sb.ladder || {};
  const dallyPicks = sb.dallyM || {};
  const results = sb.results || {};

  // Dally M ‚Äî one pick per tipper
  const dallyBody = document.getElementById('dallym-input-rows');
  dallyBody.innerHTML = TIPPERS.map(t =>
    `<tr><td style="font-weight:700;">${t}</td>
     <td><input type="text" id="dm-${t}" value="${dallyPicks[t]||''}" style="width:160px;padding:4px 6px;font-size:12px;" placeholder="Player name"></td></tr>`
  ).join('');

  // Coach picks
  const coachBody = document.getElementById('coach-input-rows');
  coachBody.innerHTML = TIPPERS.map(t =>
    `<tr><td style="font-weight:700;">${t}</td>
     <td><input type="text" id="coach-${t}" value="${coachPicks[t]||''}" style="width:160px;padding:4px 6px;font-size:12px;" placeholder="Coach/Team"></td></tr>`
  ).join('');

  // Ladder picks
  const ladderBody = document.getElementById('ladder-input-rows');
  ladderBody.innerHTML = LADDER_POSITIONS.map((pos, idx) =>
    `<tr><td><strong>${pos}</strong></td>
    ${TIPPERS.map(t => `<td><select id="lad-${t}-${idx}" style="padding:3px;font-size:11px;width:65px;">
      <option value="">‚Äì</option>
      ${TEAM_LIST.map(tm => `<option value="${tm.code}" ${((ladderPicks[t]||[])[idx]===tm.code)?'selected':''}>${tm.code}</option>`).join('')}
    </select></td>`).join('')}
    </tr>`
  ).join('');

  // Result fields
  const resultLadder = document.getElementById('sb-result-ladder');
  resultLadder.innerHTML = LADDER_POSITIONS.map((pos, idx) =>
    `<div><label style="font-size:11px;">${pos}</label>
    <select id="rl-${idx}" style="padding:4px;font-size:12px;width:100%;">
      <option value="">‚Äì</option>
      ${TEAM_LIST.map(tm => `<option value="${tm.code}" ${((results.ladder||[])[idx]===tm.code)?'selected':''}>${tm.name}</option>`).join('')}
    </select></div>`
  ).join('');

  ['dallym1','dallym2','dallym3','dallym4','dallym5','coach'].forEach(key => {
    const el = document.getElementById(`sb-result-${key}`);
    if (el) el.value = results[key] || '';
  });
}

function saveSeasonBets() {
  if (!appData.seasonBets) appData.seasonBets = {};

  // Dally M ‚Äî one pick per tipper
  const dallyM = {};
  TIPPERS.forEach(t => { dallyM[t] = document.getElementById(`dm-${t}`)?.value.trim() || ''; });
  appData.seasonBets.dallyM = dallyM;

  const coach = {};
  TIPPERS.forEach(t => { coach[t] = document.getElementById(`coach-${t}`)?.value.trim() || ''; });
  appData.seasonBets.coach = coach;

  const ladder = {};
  TIPPERS.forEach(t => { ladder[t] = LADDER_POSITIONS.map((_, idx) => document.getElementById(`lad-${t}-${idx}`)?.value || ''); });
  appData.seasonBets.ladder = ladder;

  appData.seasonBets.results = {
    dallym1: document.getElementById('sb-result-dallym1')?.value.trim() || '',
    dallym2: document.getElementById('sb-result-dallym2')?.value.trim() || '',
    dallym3: document.getElementById('sb-result-dallym3')?.value.trim() || '',
    dallym4: document.getElementById('sb-result-dallym4')?.value.trim() || '',
    dallym5: document.getElementById('sb-result-dallym5')?.value.trim() || '',
    coach: document.getElementById('sb-result-coach')?.value.trim() || '',
    ladder: LADDER_POSITIONS.map((_, idx) => document.getElementById(`rl-${idx}`)?.value || '')
  };

  saveToStorage();
  renderSeasonBets();
  showAlert('Season bets saved!', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
// Always load config from local storage first (so we know the Sheets URL)
// Then always fetch live data from Sheets before rendering anything
(async function init() {
  loadFromStorage();
  restoreConfigFields();
  showLoadingState();
  if (appData.config && appData.config.mode === 'sheets' && appData.config.sheetsUrl) {
    await loadFromSheets();
  }
  renderLeaderboard();
})();

function showLoadingState() {
  document.getElementById('leaderboard-body').innerHTML =
    '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:40px;">Loading data...</td></tr>';
}

function restoreConfigFields() {
  if (!appData.config) return;
  const modeEl = document.getElementById('data-mode');
  const urlEl = document.getElementById('sheets-url');
  const urlGroup = document.getElementById('sheets-url-group');
  if (appData.config.mode && modeEl) modeEl.value = appData.config.mode;
  if (appData.config.sheetsUrl && urlEl) urlEl.value = appData.config.sheetsUrl;
  if (appData.config.mode === 'sheets' && urlGroup) urlGroup.style.display = 'block';
}
</script>
</body>
</html>
